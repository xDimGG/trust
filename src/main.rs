#![allow(clippy::upper_case_acronyms)]

mod binary;
mod network;
mod world;

use binary::reader::Reader;
use network::server::Server;
use std::num::ParseIntError;
use std::path::Path;
use world::{binary::SafeReader, types::{DisplayDoll, Entity, EntityExtra, EntityItem, HatRack, Liquid, World, WALL_COUNT}};

impl Drop for SafeReader {
	fn drop(&mut self) {
		if self.cur < self.buf.len() {
			println!("dropped SafeReader before EOI ({} bytes remaining)", self.buf.len()-self.cur)
		}
	}
}

impl Drop for Reader<'_> {
	fn drop(&mut self) {
		if self.cur < self.buf.len() {
			println!("dropped Reader before EOI (code: {}, {} bytes remaining)", self.buf[0], self.buf.len()-self.cur)
		}
	}
}

fn decode_hex(s: &str) -> Result<Vec<u8>, ParseIntError> {
	(0..s.len())
		.step_by(2)
		.map(|i| u8::from_str_radix(&s[i..i + 2], 16))
		.collect()
}

#[tokio::main]
async fn main() {
	// let world = World::from_file(Path::new("/Users/angelolloti/Library/Application Support/Terraria/Worlds/Courtyard_of_Grasshoppers.wld")).unwrap();
	// let world = World::from_file(Path::new("C:\\Users\\Dim\\Documents\\My Games\\Terraria\\Worlds\\dim.wld")).unwrap();
	let world = World::from_file(Path::new("/mnt/c/Users/Dim/Documents/My Games/Terraria/Worlds/dim.wld")).unwrap();
	let srv = Server::new(world, "");
	srv.listen("127.0.0.1:7778").await.unwrap();

	// let world = World::from_file(Path::new("/Users/angelolloti/Library/Application Support/Terraria/Worlds/Courtyard_of_Grasshoppers.wld")).unwrap();
 
	// let Some(user_dirs) = UserDirs::new() else {
	// 	panic!("couldn't find user dir")
	// };

	// let Some(doc_dir) = user_dirs.document_dir() else {
	// 	panic!("couldn't find document dir")
	// };

	// let world_dir = doc_dir.join("My Games").join("Terraria").join("Worlds");
	// let world_files = fs::read_dir(world_dir).unwrap();

	return;

	let f = decode_hex("a00f00002c010000c8009600808306021e589201021e40c3021e58ff01021e40c3421e03802b1d02051600c600402b02051600f200409202051600dc004004020542002c00020558000000402b020542005800020558004200408a02051600c60040050205160000004005020500000000400b02051600c600400b02051600c6004011020500001600408b0205000000004005020500000000400402052c00c60002056e00420002054200dc00400a020500006e00400a02052c00c6000205580000004011020500006e00408b02052c006e0040050205000016004005020516005800400b020516000000400b0205000000004011020516005800408b02052c006e004004020542001600020558001600400402052c00dc00020558000000400b020500000000400a02052c00f200020558000000401102052c005800408b02054200580002054200dc004004020500002c00400502052c006e00400b020516006e00400b020516001600400a02050000c6004004020542002c0002056e005800020558005800408a020516006e0040050205000016004005020516000000400b020500001600400b020516000000400a0205000000004005020500000000400602051600dc00408302050000420040050205000000004005020542006e0002054200f200400a020516006e00400502051600dc00400302052c00f200020558001600400402051600c600400302052c00f20002055800000040050205000058004006020500002c00408202052c00dc0002055800000040050205160016004004020542000000020558000000400b020500006e004005020516006e0040040205160042004004020542006e0002054200f2004003020542006e0002054200dc004004020516002c00400602052c005800407b02051600dc004006020500000000400502052c005800400502052c004200400502051600f200400402050000580040050205160042004003020542002c00020558002c00400302052c00c6000205580000004004020500006e0040050205000000004006020500001600407a020542002c00020558002c00400602052c005800400502052c0058004005020542006e0002054200f20040040205000058004004020500006e00400502052c005800400402050000160040040205160016004004020542006e0002054200f2004004020500004200400602052c004200407b0205160000004006020500002c004005020516002c00400502051600580040050205000016004003020542002c0002056e00420002054200c60040040205000000004004020500002c004004020516002c0040040205000058004005020500000000400602052c006e00407b020516004200400502052c00dc00020558000000400202fe9000900002fea200900002052c00dc0002056e00420002054200f200400402052c0042004005020500006e00400402052c0042004005020516006e004004020500006e004004020500002c0040040205160016004005020500000000400302fe9000b40002fea200b4000002052c005800407b02050000b00002051600840002490000000002491200000002490000000002492400000002033600000002052c00b00002054200840002034800000002495a00000002493600000002fe9000a20002fea200a20002034800000002050000840002051600840002495a00000002491200000002493600000002490000000002052c00b0000205420084000249120000000249000000004249480000000102491200000002052c00b00002054200840002493600000002032400000002030000000002493600000002052c00b0000205420084004249360000000102495a00000002491200000002490000000002052c0084000205420084000203120000004249360000000102494800000002052c009a000205420084000203900000000249000000000249ea00000002495a00000002052c00b00002054200840002492400000002491200000002495601000002039000000002052c00b00002055800840002051600b00002495a0000000249360000000249c600000002490000000002052c00b000020558008400020516009a0002497e0000000002493600000002fe9000c60002fea200c60002052c00840002055800b000020516009a000249000000000249440100000249480000000002490000000040754202514076423402004234010042342d000234400142340b0002340042340840760234000234004234010042340100423403004234244001023440014234030042340240014234014003423404004234014076023440020234400142340100023440034234040042340c004234040002340042340500423401400902344009023440810234400142340140054234040042340340014234060042340100423401000234000234400142340200423401400902344009023440850234400542340340014234024002423402000234000234004234010042340100023400023440014234024017023440850234400642340240014234024003023440030234004234014001023400023400023440010234401902344085023440060234400442340140030234400302340002344002023400023400023440a30234400c4234014003023440050234400602344024623a010100ffff71223a0105000100623a010100ffff544072223a010800ffff021324000000421300000000524073223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff00020400000000402502040000000040080204000000004094223a012200ffff0213240000004213000000003e4087223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff40c7223a010800ffff00020400000000401f0204000000004008020400000000409a223a012200ffff02132400000042130000000038408d223a010800ffff40a7429e12400c223a010800ffff40a6029e4007029e4007029e400d223a010800ffff40a5029e00029e4005029e4005029e00029e400e223a010800ffff402002ed0000000002ed1200000002ed240000004007024f00001803024f12001803024f24001803024f360018034074429e024005029e48f505429e02400f223a010800ffff000204000000004019020400000000400202ed0000120002ed1200120002ed2400120040020204000000004003024f00002a03024f12002a03024f24002a03024f36002a034074029e505607029e48ff07029e4010223a012200ffff02132400000042130000000032406e029e50ff07029e48ff07029e4011223a010800ffff40a1029e50ff07029e48ff07029e4012223a010800ffff403b02051600c600403f42491200000001020336000000400102495a000000024924000000020348000000020300000000000203a20000000203360000004017029e50ff07029e48ff07029e4013223a010800ffff401b02d70000000002d71200000002d724000000401b020500005800403f42020b4017429e07023848ff01429e074014223a010800ffff000204000000004014020400000000400202d70000120002d71200120002d72400120040020204000000004017020500002c00403f02024234090202401e429e04401c223a012200ffff021324000000421300000000140213ea000000032013d401000042130000000006033013c20100000213d800000042130000000003021348000000421e0302133600000042130000000003400802054200160002056e005800020558006e00403e020242340100023440014234020002024041223a010800ffff4004021b48000000021b5a000000400f03201e58cc0403301e4006021e261f010000000004261f011200000004021e00021b00000000021b12000000400b020516004200403f0202423401400702024042223a010800ffff4003021b48001200021b5a001200400d421e10261f010000120004261f011200120004021e00021b00001200021b12001200400b02052c004200403f020242340140070202401202fe9000b40002fea200b400402e223a010800ffff4002021b48002400021b5a002400400d021e10ff021e0204160000004001022a0000440102042c000000021e08ff021e2662010000000004266201120000000426620124000000044404020613240000000406134800000004021e00021b00002400021b1200240040020249480000000002491200000040010249240000000249480000000002052c009a0002054200840002493600000002491200000002490000000002034800000002494800000002033600000002034800000002494800000040370202023440080202400302fe9000b40002fea200b40040080203120000000002034800000002495a00000002fe9000c60002fea200c600024912000000020336000000401002494800000002e3660000000203240000000249b4000000024956010000020390000000024948000000020336000000420324000000010203360000000249240000000249480000000249000000000249480000000249240000000203120000000249480000004249120000000102495a0000000249000000000249360000000249000000000203480000000203b40000000249480000004001223a011c00ffff42490000000001021b48003600021b5a0036000249240000000002492400000002032400000002491200000002032400000002035a00000040010249ea000000024900000000020348000000024936000000024912000000421e022244010000160022440116001600024924000000022a0000560122440116000000421e02266201000012000426620112001200042662012400120004267901000000000426790112000000042679012400000004067d0000000004067d1200000004021e024948000000021b00003600021b12003600400142021203200202490000000040070203240000004002021400000000400d0249d800000000020336000000000203480000000002494800000002495601000002035a00000040050249fc00000002039000000002035a0000000249b40000000203240000000203360000000002e376010000020390000000400202020234400802020203480000000203240000000203b40000000002fe9000c60002fea200c6000203000000000249240000000002495a0000000249d800000002031200000002035a00000040014202070002495601000002030000000002032400000002491200000002034800000040020249480000000203000000000203240000000249c600000002033600000002491200000002495a000000033002420230020042020602000202266201000024000426620112002400042662012400240004267901000012000426790112001200042679012400120004067d0000120004067d1200120004021e420202400106000246003b0106000206003b4600020b4200014202010310020203120000000249000000000249120000000002031200000002495a000000033002020203200202e36600000002494800000002140000120002497e00000002035a000000000203000000004001024900000000004249120000000100020336000000024936000000031002420209004202104003021324000000021312000000400342020d2283010000000022830112000000020246003b024600020206020242021042000146000201461e0419021e061e04021e461e042544040106000246003b034600020d42000142020702004202114200024600020502020042340e0002344009423402004234094001020246003b024600021006020246000206061e04440406061e044404060604000000000444040b0604000000000406f7000000000406f7120000000406f72400000004066a0000000004066a1200000004066a240000000444040406042c00000004061e04440406021e440406061e04440406061e04040426820100000000044600020146003b0146000234020200423401004234030042340200423402000234400202fe9000480002fea2004800400102fe9000000002fea200000000423402004234084002020246003b0246000218061e040604160000000444040406042c00000004061e040404061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406f7000012000406f7120012000406f72400120004066a0000120004066a1200120004066a2400120004068500000000040685120000000406852400000004065e0000000004065e12000000040404061e040604160000000444040406042c00000004021e0604160000000444040406042c00000004061e040604160000000444040406042c00000004461e040126820100001200040600020602024600021b0602024600021806003b02020203360000000249440100000203a2000000020300000000020336000000000249000000000249240000000002340203480000000249240000000203360000000203240000000249480000000002034800000002493600000002037e00000002035a00000002491200000002fe90005a0002fea2005a0002490000000002031200000002fe9000120002fea200120002034800000002340002494800000002037e00000002030000000002035a0000000249480000000249200100000203480000000249360000000249a20000000249360000000249240000000249fc000000024936000000020312000000020246003b0246000218061e04440405060b2400000004060b36000000040404061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406f7000024000406f7120024000406f72400240004066a0000240004066a1200240004066a2400240004068500001200040685120012000406852400120004065e0000120004065e12001200040404060b0000000004060b120000000444040106ae0000000004440402060b0000000004060b1200000004440404060b2400000004060b360000000426400100000000042640011200000004440404060b0000000004060b120000000404044600023842022d4600021b061e04440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b360012000406132400000004461300000000041e06131200000004060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f00000000040404060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b360012000426400100001200042640011200120004060e0000000004060e1200000004060e2400000004060f00000000040404060b0000120004060b120012000404044600022d46003b014600020b4200014600020206003b4600020446003b0102004600020d46003b03460002080602024600021c061e04440401060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b3600240004040406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040404263f010000000004263f011200000004440401061d0000000004061d1200000004067200000000040672120000000406722400000004440401060b0000240004060b12002400040404060e0000120004060e1200120004060e2400120004060f00001200040404060b0000240004060b12002400040404060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b360024000426400100002400042640011200240004060e0000120004060e1200120004060e2400120004060f00001200040404060b0000240004060b12002400040404460002080602024600022246003b0106023b06003b0602024600020b06070206000206003b4600020446003b024600020b0602024600020246003b0246000226461e0408040406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040404263f010000120004263f01120012000406860000000004068612000000040612000000000406121200000004067200001200040672120012000406722400120004040406040000000004061e040613360000000406134800000004461e04050613360000000406134800000004461e04050613360000000406134800000004461e040506133600000004061300000000044600022b46003b054600020a4607020106003b4600020346003b034600021006003b06023b46003b010600020602024600020406020246000225061e0406133600000004461300000000041e06134800000004061e04440401062200000e0104062212000e0104062224000e0104440401061e04440406061e0444040106f0880236000406f09a0236000406f0ac02360004440401061e04040406686402000004460002100602024600021a46003b06460002050602024600020206073b4600020506003b4600021346003b024600020206020246000229061e044404060604000000000444040b0604000000000426310100000000042631011200000004263101240000000406e4000000000406e4120000000406e4240000000406db000000000406db120000000406db240000000444040106042c00000004061e04060416000000040404062200002001040622120020010406222400200104040406042c00000004061e040604160000000444040406042c00000004061e0406041600000004040406f0880248000406f09a0248000406f0ac02480004040406042c00000004061e040404066864021200044600022d46003b084600020606003b4600021706020246000232061e0404040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406158c0100000406159e01000004061500000000040615120000000426310100001200042631011200120004263101240012000406e4000012000406e4120012000406e4240012000406db000012000406db120012000406db240012000406600000000004066012000000040404060b0000000004060b120000000404040622000032010406221200320104062224003201040404060b2400000004060b36000000040669e4060000040669f606000004440403060b2400000004060b36000000042640010000000004264001120000000406f088025a000406f09a025a000406f0ac025a00040404060b2400000004060b36000000040404066864022400044600022a0602024600020346003b054600020506003b4600020946003b0146000241061e0404040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406158c0112000406159e01120004061500001200040615120012000426310100002400042631011200240004263101240024000406e4000024000406e4120024000406e4240024000406db000024000406db120024000406db240024000406600000120004066012001200040404060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b36001200040669e4061200040669f606120004060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b360012000426400100001200042640011200120004060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b36001200040404066864023600044600021906a702460002060602020600020602024600022146003b02460002110602024600022d061e0406133600000004461300000000041e06131200000004060b0000240004060b12002400040404060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b36002400040669e4062400040669f606240004060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b360024000426400100002400042640011200240004060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b36002400040404066864024800044600021846a702014600020d060202460002010602024600021206003b4600020446003b0246000241061e0404040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406158c0100000406159e010000040615080700000406151a0700000406d9000000000406d9120000000406d9240000000406da000000000406da120000000406da240000000406560000000004065612000000040656240000000406587a0100000406588c0100000406589e01000004061e040613360000000406134800000004461e04050613360000000406134800000004461e04050613360000000406134800000004461e040506133600000004061300000000044600024246003b044600020f06020246000223460102014600020b061e0404040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406158c0112000406159e011200040615080712000406151a0712000406d9000012000406d9120012000406d9240012000406da000012000406da120012000406da240012000406560000120004065612001200040656240012000406587a0112000406588c0112000406589e01120004061e3b440406061e04440406061e04440406061e040404066880040000044600024146003b044600022d06020246000205460102024600020b061e0406133600000004461300000000041e06134800000004061e040604160000000444040406042c00000004061e040604160000000444040406042c00000004061e040604160000000444040406042c00000004061e04040406688004120004460002370602024600020746003b0446000233460102054600020a061e0444040606040000000004440403269c010000000004269c011200000004269c012400000004267a012400000004267a013600000004267a012400000004267a01360000000426640100000000042664011200000004262c010000000004262c011200000004262c012400000004266301000000000426630112000000042663012400000004262f010000000004262f011200000004262f012400000004263401000000000426340112000000042634012400000004060b0000000004060b1200000004440404060b2400000004060b3600000004440405060b2400000004060b3600000004440405060b2400000004060b36000000040404066880042400044600023d46003b034600021306003b4600021d46010202460002014601020646000209061e0404040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004440402269c010000120004269c011200120004269c012400120004267a012400120004267a013600120004267a012400120004267a01360012000426640100001200042664011200120004262c010000120004262c011200120004262c012400120004266301000012000426630112001200042663012400120004262f010000120004262f011200120004262f012400120004263401000012000426340112001200042634012400120004060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004040406688004360004460002330602024600020946003b024600021806003b460002174601020d46000208061e0404040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004440402269c010000240004269c011200240004269c012400240004267a012400240004267a013600240004267a012400240004267a01360024000426640100002400042664011200240004262c010000240004262c011200240004262c012400240004266301000024000426630112002400042663012400240004262f010000240004262f011200240004262f012400240004263401000024000426340112002400042634012400240004060b0000240004060b12002400040404060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b3600240004440401060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b3600240004440401060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b36002400040404066880044800044600020c0602024600020d0602024600020a0602024600023206003b46000215460102050600024601020746000208061e0406133600000004461300000000041e06134800000004061e040613360000000406134800000004461e04050613360000000406134800000004461e04050613360000000406134800000004461e040506133600000004061300000000044600025c06003b460002134601020f4600020546010202061e0404040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004061500000000040615120000000406150000000004061512000000040615000000000406151200000004440405061e0444040206f5900000000406f5a200000004440401061e04440406061e04440406061e04040406684800000004460002190607024600024206003b4600021246010207060002460102064600020146010206061e0404040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004061500001200040615120012000406150000120004061512001200040615000012000406151200120004440405061e040604160000000444040106f5900012000406f5a200120004040406042c00000004061e040604160000000444040406042c00000004061e04060416000000040404263f010000000004263f01120000000444040106042c00000004061e0404040668480012000446000218460702024600021d0602024600022306003b46000210460102024600020246010201460002014601020606000246010207061e0406133600000004461300000000041e06131200000004060b0000000004060b120000000444040106f5900024000406f5a2002400040404060b2400000004060b3600000004440405060b2400000004060b3600000004440401263f010000120004263f011200120004440401060b2400000004060b360000000404040668480024000446000217460702034600020c060202460002250602024600020e06003b46000210460102014600020546010210061e044404060604000000000444040b0604000000000444040b060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b36001200040404066848003600044600020a0602024600020b46070203460002190602024600022106020246000217460102024600020346010211061e040404061500000000040615120000000444041d060b0000240004060b12002400040404060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b3600240004440401060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b3600240004440401060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b360024000404040668480048000446023f05460002580602024600021846010211061e040404061500001200040615120012000444041d061e040613360000000406134800000004461e04050613360000000406134800000004461e04050613360000000406134800000004461e0405061336000000040613000000000406023f06343f06344146343f0106024106023f4600020c0602024600022c0602024600022f06070246000202460102074600020146010208060002061e0406133600000004461300000000041e06134800000004061e04440406061e04440406061e04440406061e0444040146343f0546023f01460002100602024600023b060202460002184607020446000201460102074600020246010207060002461e0413021e461e0404021e461e04070604160000000444040406042c00000004061e040604160000000444040406042c00000004061e040604160000000444040406042c00000004061e040665380400000406654a0400000446343f0606023f06003f4600024246003b044600021e460702044601020746000204460102064600021306003b4600020e061e04440406060b0000000004060b1200000004440404060b2400000004060b3600000004440405060b2400000004060b36000000040665380412000406654a0412000446343f0646023f014600020b0602024600023446003b0206000206020206003b4600021e46070204460102054600021f46003b014600020a06020246000203061e04440401060e0000000004060e1200000004060e2400000004060f00000000040404060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b36001200040665380424000406654a0424000446343f0706024106003f46000224460102014600021846003b014600020306003b46000221460102064600020c460102014600021046003b01460002010602024600020d061e04440401060e0000120004060e1200120004060e2400120004060f00001200040404060b0000240004060b12002400040404060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b3600240004440401060e0000120004060e1200120004060e2400120004060f0000120004060b2400240004060b36002400040665380436000406654a0436000446343f0706023f06003f4600022346010203460002240602024600021a46010201460002114601020146000223061e040613360000000406134800000004461e04050613360000000406134800000004461e04050613360000000406134800000004461e0405061336000000040613000000000406013f46343f044634410106023f06003f460002070602024600021946010205460002400601024600020306020246000208060202460002014601020246000223061e04440406061e04440406061e04440406061e0244040106013f0720013f06b9240000003f06343f06344146343f0106344106023f06003f4600022146010206460002140602024600022b0601024600020f4601020246000223061e040604160000000444040406042c00000004061e040604160000000444040406042c00000004061e040604160000000444040406042c00000004021e44040146013f0246343f0406023f06003f4600021f460102084600022c060202460002234601020346000223061e04440405060b2400000004060b3600000004440406060b0000000004060b1200000004440404060b2400000004060b360000000444040146013f01043f46343f0406023f06003f4600020d46003b0246000210460102064600020a0602024600021706020246000219060202460002114601020646000220061e04440401060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b3600120004440401060e0000000004060e1200000004060e2400000004060f00000000040404060b0000120004060b12001200040404060e0000000004060e1200000004060e2400000004060f0000000004060b2400120004060b36001200044404013b0097012d10a10110576561706f6e7320284f74686572732996012f10a101054d61736b7395013110a101094d6174657269616c7394013310a1010d4d697363656c6c616e656f757393013510a1010742616e6e65727391013710a1010742616e6e65727342013910a1010742616e6e65727306003b10a1010742616e6e65727384013d10a1010742616e6e657273a3003f10a1010746697368696e679a012d10a4010945717569706d656e7499012f10a4010945717569706d656e7498013110a4010945717569706d656e7490013310a4010945717569706d656e748f013510a4010945717569706d656e748e013710a4010945717569706d656e7434013910a4010945717569706d656e7438013b10a40107506f74696f6e733b013d10a4010b50726f6a656374696c657340013f10a401094d6174657269616c739b012d10a8010f446576656c6f706572204974656d73e5002f10a8010f446576656c6f706572204974656d73ad013110a801134865616c74682f4d616e6120506f74696f6e737f013310a80106576972696e6727013510a801084d696e6572616c7392013710a801084d696e6572616c733b003910a801084d696e6572616c7347013b10a801044479657332013d10a801044f72657329013f10a80106506c616e74739e012d10ab010853746174696f6e739d012f10ab010854726f70686965739c013110ab0105546f6f6c7307003310ab01064368657374730b003510ab01075374617475657308003710ab01054c6967687409003910ab0104416d6d6fa4003b10ab0104466f6f6445003d10ab010f4f7265732028486172646d6f6465291d003f10ab010b506972617465204c6f6f740a004a10ab0100a7012d10af0105486f6f6b73a8012f10af010b506574732f4d6f756e7473ac013110af010557696e6773ae013310af010b4d7573696320426f7865739f012d10b2010653776f726473a0012f10b20105596f796f73a1013110b20106537065617273a2013310b2010a426f6f6d6572616e6773a3013510b20106466c61696c73a4013710b2010e426f77732f526570656174657273a5013910b2010447756e73a6013b10b201094c61756e636865727323013d10b2010557616e647324013f10b2010a4d616769632047756e73a9014110b2010b5370656c6c20546f6d6573aa014310b2010953756d6d6f6e657273ab014510b2011053656e7472792053756d6d6f6e657273af012d10b6010948616c6c6f7765656e0000020000010000003b10ae01ffff00000000003d10ae01ffff").unwrap();
	let mut r = Reader::new(f.as_slice());
	let x_start = r.read_i32() as usize;
	let y_start = r.read_i32() as usize;
	let width = r.read_i16() as usize;
	let height = r.read_i16() as usize;

	let mut repeat = 0;

	for x in x_start..(x_start + width) {
		for y in y_start..(y_start + height) {
			// if y == y_start + 50 {
			// 	return;
			// }
			if repeat > 0 {
				repeat -= 1;
				continue;
			}

			// Header bytes
			let h_1 = r.read_byte();
			let h_2 = if h_1 & 1 == 1 { r.read_byte() } else { 0 };
			let h_3 = if h_2 & 1 == 1 { r.read_byte() } else { 0 };
			let h_4 = if h_3 & 1 == 1 { r.read_byte() } else { 0 };

			let (active, id, frame_x, frame_y, color) = if h_1 & 2 == 2 {
				let id = if h_1 & 32 == 32 {
					r.read_i16()
				} else {
					r.read_byte() as i16
				};

				let (x, y) = if world.format.importance[id as usize] {
					let x = r.read_i16();
					let y = r.read_i16();
					(x, if id == 144 { 0 } else { y })
				} else { (-1, -1) };

				let col = if h_3 & 8 == 8 { r.read_byte() } else { 0 };

				(true, id, x, y, col)
			} else {
				(false, -1, 0, 0, 0)
			};

			let (wall, wall_color) = if h_1 & 4 == 4 {
				(r.read_byte() as u16, if h_3 & 16 == 16 { r.read_byte() as u16 } else { 0 })
			} else { (0, 0) };

			let liquid_bits = (h_1 & 0b11000) >> 3;
			let (liquid, liquid_header) = if liquid_bits != 0 {
				(if h_3 & 128 == 128 {
					Liquid::Shimmer // shimmer
				} else {
					match liquid_bits {
						2 => Liquid::Lava, // lava
						3 => Liquid::Honey, // honey
						_ => Liquid::Water, // water
					}
				}, r.read_byte())
			} else {
				(Liquid::None, 0)
			};

			let (wire_1, wire_2, wire_3, half_brick, slope) = if h_2 > 1 {
				let n_9 = (h_2 & 0b1110000) >> 4;
				// todo: add check for Main.tileSolid[(int) tile.type] || TileID.Sets.NonSolidSaveSlopes[(int) tile.type])
				let (hb, sl) = if n_9 != 0 {
					(n_9 == 1, n_9 - 1)
				} else { (false, 0) };
				(h_2 & 2 == 2, h_2 & 4 == 4, h_2 & 8 == 8, hb, sl)
			} else { (false, false, false, false, 0) };

			let (actuator, in_active, wire_4, wall) = if h_3 > 1 {
				let wall_extended = if h_3 & 64 == 64 {
					let new_wall = (r.read_byte() as u16) << 8 | wall;
					if new_wall < WALL_COUNT {
						new_wall
					} else {
						0
					}
				} else { wall };
				(h_3 & 2 == 2, h_3 & 4 == 4, h_3 & 32 == 32, wall_extended)
			} else { (false, false, false, wall) };

			let (invisible_block, invisible_wall, fullbright_block, fullbright_wall) = if h_4 > 1 {
				(h_4 & 2 == 2, h_4 & 4 == 4, h_4 & 8 == 8, h_4 & 16 == 16)
			} else { (false, false, false, false) };

			repeat = match (h_1 & 0b11000000) >> 6 {
				0 => 0,
				1 => r.read_byte() as i32,
				_ => r.read_i16() as i32,
			};

			println!("tile id {} repeats {}, cur: {}", id, repeat, r.cur);
		}
	}

	for _ in 0..r.read_i16() {
		println!("chest, id = {}, x = {}, y = {}, name = {:?}", r.read_i16(), r.read_i16(), r.read_i16(), r.read_string());
	}

	for _ in 0..r.read_i16() {
		println!("sign, id = {}, x = {}, y = {}, text = {:?}", r.read_i16(), r.read_i16(), r.read_i16(), r.read_string());
	}

	for _ in 0..r.read_i16() {
		let entity_type = r.read_byte();
		let id = r.read_i32();
		let x = r.read_i16();
		let y = r.read_i16();

		let entity = match entity_type {
			0 => EntityExtra::Dummy { npc: r.read_i16() },
			1 => EntityExtra::ItemFrame(EntityItem { id: r.read_i16(), prefix: r.read_byte(), stack: r.read_i16() }),
			2 => EntityExtra::LogicSensor { logic_check: r.read_byte(), on: r.read_bool() },
			3 => {
				let mut doll = DisplayDoll::default();
				let mut item_flags = r.read_byte();
				let mut dye_flags = r.read_byte();

				for item in &mut doll.items {
					if item_flags & 1 == 1 {
						item.id = r.read_i16();
						item.prefix = r.read_byte();
						item.stack = r.read_i16();
					}
					item_flags >>= 1;
				};

				for item in &mut doll.dyes {
					if dye_flags & 1 == 1 {
						item.id = r.read_i16();
						item.prefix = r.read_byte();
						item.stack = r.read_i16();
					}
					dye_flags >>= 1;
				};

				EntityExtra::DisplayDoll(doll)
			}
			4 => EntityExtra::WeaponsRack(EntityItem { id: r.read_i16(), prefix: r.read_byte(), stack: r.read_i16() }),
			5 => {
				let mut rack = HatRack::default();
				let mut flags = r.read_byte();

				for item in &mut rack.items {
					if flags & 1 == 1 {
						item.id = r.read_i16();
						item.prefix = r.read_byte();
						item.stack = r.read_i16();
					}
					flags >>= 1;
				};

				for item in &mut rack.dyes {
					if flags & 1 == 1 {
						item.id = r.read_i16();
						item.prefix = r.read_byte();
						item.stack = r.read_i16();
					}
					flags >>= 1;
				};

				EntityExtra::HatRack(rack)
			}
			6 => EntityExtra::FoodPlatter(EntityItem { id: r.read_i16(), prefix: r.read_byte(), stack: r.read_i16() }),
			7 => EntityExtra::TeleportationPylon,
			_ => { continue; },
		};

		dbg!(Entity { id, x, y, entity });
	}
}
